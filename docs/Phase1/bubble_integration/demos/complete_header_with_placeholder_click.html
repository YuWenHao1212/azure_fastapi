<!-- === å®Œæ•´çš„ Page HTML Header - åŒ…å«ä¸‰å€‹ç³»çµ± === -->

<!-- ç³»çµ± 1: åŸæœ¬çš„å–®ä¸€æ§åˆ¶ç³»çµ± -->
<script>
/**
 * å„ªé›…è§£æ±ºæ–¹æ¡ˆ - è®“æˆ‘å€‘çš„æ¨£å¼æˆç‚ºé è¨­æ¨£å¼
 * Elegant Solution - Making our styles the default
 * 
 * é€™å€‹æ–¹æ¡ˆåªéœ€è¦åœ¨é é¢è¼‰å…¥æ™‚æ³¨å…¥ä¸€æ¬¡æ¨£å¼ï¼Œä¹‹å¾Œåªéœ€åˆ‡æ› class
 */

(function() {
    'use strict';
    
    // æ¨™è¨˜æˆ‘å€‘çš„æ¨£å¼æ˜¯å¦å·²ç¶“æ³¨å…¥
    window.markerStylesInjected = false;
    
    /**
     * æ³¨å…¥é è¨­æ¨£å¼ - åªéœ€åŸ·è¡Œä¸€æ¬¡
     * é€™æœƒè®“ opt-tags é è¨­å°±æœ‰æˆ‘å€‘å®šç¾©çš„å¯è¦‹æ¨£å¼
     */
    window.injectDefaultMarkerStyles = function() {
        if (window.markerStylesInjected) {
            console.log('âœ… æ¨£å¼å·²å­˜åœ¨ï¼Œç„¡éœ€é‡è¤‡æ³¨å…¥');
            return true;
        }
        
        try {
            // ç­‰å¾… TinyMCE æº–å‚™å¥½
            if (typeof tinymce === 'undefined' || !tinymce.activeEditor) {
                console.log('â³ TinyMCE å°šæœªæº–å‚™å¥½');
                return false;
            }
            
            const editor = tinymce.activeEditor;
            const iframeDoc = editor.getDoc();
            
            // å‰µå»ºæ¨£å¼å…ƒç´ 
            const style = iframeDoc.createElement('style');
            style.id = 'default-marker-styles';
            style.textContent = `
                /* === é è¨­æ¨£å¼ - opt-tags çš„å¯è¦‹ç‹€æ…‹ === */
                
                /* opt-new - æ–°å¢å€æ®µ (ç¶ è‰²) */
                .opt-new {
                    background-color: rgba(16, 185, 129, 0.1) !important;
                    border-left: 4px solid #10B981 !important;
                    padding-left: 16px !important;
                    margin: 4px 0 !important;
                    transition: all 0.3s ease;
                }
                
                /* opt-modified - ä¿®æ”¹å…§å®¹ (é»ƒè‰²) */
                .opt-modified {
                    background-color: #fef3c7 !important;
                    padding: 2px 6px !important;
                    border-radius: 3px !important;
                    transition: all 0.3s ease;
                }
                
                /* opt-placeholder - ä½”ä½ç¬¦ (ç´…è‰²) */
                .opt-placeholder {
                    background-color: #fee2e2 !important;
                    color: #991b1b !important;
                    border: 1px dashed #f87171 !important;
                    padding: 2px 8px !important;
                    border-radius: 4px !important;
                    font-style: italic !important;
                    transition: all 0.3s ease;
                    cursor: pointer !important;
                    display: inline-block !important;
                }
                
                .opt-placeholder:hover {
                    background-color: #fecaca !important;
                    border-color: #ef4444 !important;
                }
                
                /* opt-keyword - æ–°é—œéµå­— (ç´«è‰²) */
                .opt-keyword {
                    background-color: transparent !important;
                    color: #6366f1 !important;
                    border: 1px solid #c7d2fe !important;
                    padding: 2px 6px !important;
                    border-radius: 3px !important;
                    font-weight: 500 !important;
                    transition: all 0.3s ease;
                }
                
                /* opt-keyword-existing - ç¾æœ‰é—œéµå­— (è—è‰²) */
                .opt-keyword-existing {
                    background-color: #2563eb !important;
                    color: white !important;
                    padding: 3px 8px !important;
                    border-radius: 4px !important;
                    font-weight: 600 !important;
                    transition: all 0.3s ease;
                }
                
                /* === éš±è—æ¨¡å¼ - ç•¶ body æœ‰ markers-hidden class æ™‚ === */
                
                body.markers-hidden .opt-new,
                body.markers-hidden .opt-modified,
                body.markers-hidden .opt-placeholder,
                body.markers-hidden .opt-keyword,
                body.markers-hidden .opt-keyword-existing {
                    background-color: transparent !important;
                    border: none !important;
                    padding: 0 !important;
                    margin: 0 !important;
                    color: inherit !important;
                    font-weight: normal !important;
                    font-style: normal !important;
                    border-radius: 0 !important;
                }
            `;
            
            // æ³¨å…¥æ¨£å¼åˆ° iframe head
            iframeDoc.head.appendChild(style);
            
            // æ¨™è¨˜æ¨£å¼å·²æ³¨å…¥
            window.markerStylesInjected = true;
            
            console.log('âœ… é è¨­æ¨™è¨˜æ¨£å¼å·²æˆåŠŸæ³¨å…¥');
            return true;
            
        } catch (error) {
            console.error('âŒ æ³¨å…¥æ¨£å¼æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            return false;
        }
    };
    
    /**
     * ç°¡å–®çš„åˆ‡æ›å‡½æ•¸ - åªéœ€åˆ‡æ› class
     * @param {boolean} hideMarkers - true éš±è—, false é¡¯ç¤º
     */
    window.toggleMarkers = function(hideMarkers) {
        try {
            if (typeof tinymce === 'undefined' || !tinymce.activeEditor) {
                console.error('âŒ TinyMCE ç·¨è¼¯å™¨æœªæ‰¾åˆ°');
                return false;
            }
            
            const editor = tinymce.activeEditor;
            const iframeDoc = editor.getDoc();
            const body = iframeDoc.body;
            
            // ç¢ºä¿æ¨£å¼å·²æ³¨å…¥
            if (!window.markerStylesInjected) {
                window.injectDefaultMarkerStyles();
            }
            
            // ç°¡å–®åˆ‡æ› class
            if (hideMarkers) {
                body.classList.add('markers-hidden');
                console.log('ğŸ”´ æ¨™è¨˜å·²éš±è—');
            } else {
                body.classList.remove('markers-hidden');
                console.log('ğŸŸ¢ æ¨™è¨˜å·²é¡¯ç¤º');
            }
            
            // è¼•é‡ç´šåˆ·æ–°
            body.style.opacity = '0.99';
            setTimeout(() => {
                body.style.opacity = '1';
            }, 10);
            
            return true;
            
        } catch (error) {
            console.error('âŒ åˆ‡æ›æ¨™è¨˜æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            return false;
        }
    };
    
    /**
     * è‡ªå‹•åˆå§‹åŒ– - åœ¨ TinyMCE æº–å‚™å¥½æ™‚æ³¨å…¥æ¨£å¼
     */
    window.initializeMarkerSystem = function() {
        console.log('ğŸš€ åˆå§‹åŒ–æ¨™è¨˜ç³»çµ±...');
        
        const checkInterval = setInterval(function() {
            if (typeof tinymce !== 'undefined' && tinymce.activeEditor) {
                // æ³¨å…¥é è¨­æ¨£å¼
                if (window.injectDefaultMarkerStyles()) {
                    clearInterval(checkInterval);
                    console.log('âœ… æ¨™è¨˜ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
                    
                    // ç¢ºä¿åˆå§‹ç‹€æ…‹æ˜¯é¡¯ç¤ºæ¨™è¨˜ï¼ˆç§»é™¤ markers-hidden classï¼‰
                    const editor = tinymce.activeEditor;
                    const iframeDoc = editor.getDoc();
                    iframeDoc.body.classList.remove('markers-hidden');
                    console.log('ğŸŸ¢ åˆå§‹ç‹€æ…‹ï¼šé¡¯ç¤ºæ¨™è¨˜');
                }
            }
        }, 500);
        
        // 30ç§’å¾Œåœæ­¢å˜—è©¦
        setTimeout(() => clearInterval(checkInterval), 30000);
    };
    
    // é é¢è¼‰å…¥æ™‚è‡ªå‹•åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', window.initializeMarkerSystem);
    } else {
        window.initializeMarkerSystem();
    }
    
    // åˆå§‹åŒ–å…¨å±€ç‹€æ…‹è®Šæ•¸ï¼ˆèˆ‡é é¢è¼‰å…¥æ™‚çš„é¡¯ç¤ºç‹€æ…‹ä¸€è‡´ï¼‰
    window.markersVisible = true;
    
})();

// === å…¨å±€å‡½æ•¸ä¾› Bubble ä½¿ç”¨ ===

/**
 * ä¸»è¦çš„ toggle å‡½æ•¸ - ä¾› Bubble workflow èª¿ç”¨
 */
window.toggleTinyMCEMarkers = function(hideMarkers) {
    return window.toggleMarkers(hideMarkers);
};

/**
 * ä¾¿åˆ©å‡½æ•¸
 */
window.showMarkers = function() {
    return window.toggleMarkers(false);
};

window.hideMarkers = function() {
    return window.toggleMarkers(true);
};
</script>

<!-- ç³»çµ± 2: å¤šæ¨™è¨˜ç¨ç«‹æ§åˆ¶ç³»çµ± -->
<script>
/**
 * å¤šæ¨™è¨˜ç¨ç«‹æ§åˆ¶ç³»çµ±
 * å¯ä»¥åˆ†åˆ¥æ§åˆ¶5ç¨®ä¸åŒçš„ opt-tag é¡¯ç¤º/éš±è—
 */

(function() {
    'use strict';
    
    // å®šç¾©5ç¨®æ¨™è¨˜é¡å‹
    window.tagTypes = {
        'opt-new': {
            name: 'æ–°å¢å€æ®µ',
            color: 'green',
            visible: true
        },
        'opt-modified': {
            name: 'ä¿®æ”¹å…§å®¹',
            color: 'yellow',
            visible: true
        },
        'opt-placeholder': {
            name: 'ä½”ä½ç¬¦',
            color: 'red',
            visible: true
        },
        'opt-keyword': {
            name: 'æ–°é—œéµå­—',
            color: 'purple',
            visible: true
        },
        'opt-keyword-existing': {
            name: 'ç¾æœ‰é—œéµå­—',
            color: 'blue',
            visible: true
        }
    };
    
    // æ³¨å…¥å¤šæ¨™è¨˜æ§åˆ¶æ¨£å¼
    window.injectMultiTagStyles = function() {
        try {
            if (typeof tinymce === 'undefined' || !tinymce.activeEditor) {
                console.log('â³ TinyMCE å°šæœªæº–å‚™å¥½');
                return false;
            }
            
            const editor = tinymce.activeEditor;
            const iframeDoc = editor.getDoc();
            
            // æª¢æŸ¥æ˜¯å¦å·²æ³¨å…¥
            if (iframeDoc.getElementById('multi-tag-styles')) {
                console.log('âœ… æ¨£å¼å·²å­˜åœ¨');
                return true;
            }
            
            const style = iframeDoc.createElement('style');
            style.id = 'multi-tag-styles';
            style.textContent = `
                /* === å€‹åˆ¥éš±è—æ¨£å¼ === */
                
                /* éš±è— opt-new */
                body.hide-opt-new .opt-new {
                    background-color: transparent !important;
                    border: none !important;
                    padding: 0 !important;
                    margin: 0 !important;
                }
                
                /* éš±è— opt-modified */
                body.hide-opt-modified .opt-modified {
                    background-color: transparent !important;
                    padding: 0 !important;
                    border-radius: 0 !important;
                }
                
                /* éš±è— opt-placeholder - ä¿ç•™é»æ“ŠåŠŸèƒ½ */
                body.hide-opt-placeholder .opt-placeholder {
                    background-color: transparent !important;
                    color: inherit !important;
                    border: none !important;
                    padding: 0 !important;
                    font-style: normal !important;  /* é‡è¦ï¼šéš±è—æ™‚ä¸æ˜¯æ–œé«” */
                    cursor: pointer !important;     /* ä¿æŒå¯é»æ“Š */
                    transition: all 0.2s ease;
                }
                
                /* éš±è—ç‹€æ…‹ä¸‹çš„ hover æ•ˆæœ - æç¤ºå¯é»æ“Š */
                body.hide-opt-placeholder .opt-placeholder:hover {
                    background-color: rgba(254, 226, 226, 0.1) !important;
                    border: 1px dashed rgba(248, 113, 113, 0.2) !important;
                    padding: 2px 8px !important;
                }
                
                /* éš±è— opt-keyword */
                body.hide-opt-keyword .opt-keyword {
                    background-color: transparent !important;
                    color: inherit !important;
                    border: none !important;
                    padding: 0 !important;
                    font-weight: normal !important;
                }
                
                /* éš±è— opt-keyword-existing */
                body.hide-opt-keyword-existing .opt-keyword-existing {
                    background-color: transparent !important;
                    color: inherit !important;
                    padding: 0 !important;
                    font-weight: normal !important;
                    border-radius: 0 !important;
                }
            `;
            
            iframeDoc.head.appendChild(style);
            console.log('âœ… å¤šæ¨™è¨˜æ¨£å¼å·²æ³¨å…¥');
            return true;
            
        } catch (error) {
            console.error('âŒ æ³¨å…¥æ¨£å¼æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            return false;
        }
    };
    
    /**
     * åˆ‡æ›å–®å€‹æ¨™è¨˜é¡å‹çš„é¡¯ç¤º/éš±è—
     * @param {string} tagType - æ¨™è¨˜é¡å‹ (å¦‚ 'opt-new')
     * @param {boolean} show - true é¡¯ç¤º, false éš±è—
     */
    window.toggleSingleTag = function(tagType, show) {
        try {
            if (typeof tinymce === 'undefined' || !tinymce.activeEditor) {
                console.error('âŒ TinyMCE ç·¨è¼¯å™¨æœªæ‰¾åˆ°');
                return false;
            }
            
            const editor = tinymce.activeEditor;
            const iframeDoc = editor.getDoc();
            const body = iframeDoc.body;
            
            // ç¢ºä¿æ¨£å¼å·²æ³¨å…¥
            if (!iframeDoc.getElementById('multi-tag-styles')) {
                window.injectMultiTagStyles();
            }
            
            const hideClass = `hide-${tagType}`;
            
            if (show) {
                body.classList.remove(hideClass);
                console.log(`ğŸŸ¢ é¡¯ç¤º ${tagType}`);
            } else {
                body.classList.add(hideClass);
                console.log(`ğŸ”´ éš±è— ${tagType}`);
            }
            
            // æ›´æ–°ç‹€æ…‹
            if (window.tagTypes[tagType]) {
                window.tagTypes[tagType].visible = show;
            }
            
            // è¼•é‡ç´šåˆ·æ–°
            body.style.opacity = '0.99';
            setTimeout(() => {
                body.style.opacity = '1';
            }, 10);
            
            return true;
            
        } catch (error) {
            console.error('âŒ åˆ‡æ›æ¨™è¨˜æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            return false;
        }
    };
    
    /**
     * é¡¯ç¤ºæ‰€æœ‰æ¨™è¨˜
     */
    window.showAllTags = function() {
        Object.keys(window.tagTypes).forEach(tagType => {
            window.toggleSingleTag(tagType, true);
        });
        console.log('âœ… é¡¯ç¤ºæ‰€æœ‰æ¨™è¨˜');
    };
    
    /**
     * éš±è—æ‰€æœ‰æ¨™è¨˜
     */
    window.hideAllTags = function() {
        Object.keys(window.tagTypes).forEach(tagType => {
            window.toggleSingleTag(tagType, false);
        });
        console.log('âœ… éš±è—æ‰€æœ‰æ¨™è¨˜');
    };
    
    /**
     * åˆå§‹åŒ–å¤šæ¨™è¨˜ç³»çµ±
     */
    window.initializeMultiTagSystem = function() {
        console.log('ğŸš€ åˆå§‹åŒ–å¤šæ¨™è¨˜æ§åˆ¶ç³»çµ±...');
        
        const checkInterval = setInterval(function() {
            if (typeof tinymce !== 'undefined' && tinymce.activeEditor) {
                if (window.injectMultiTagStyles()) {
                    clearInterval(checkInterval);
                    console.log('âœ… å¤šæ¨™è¨˜ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
                }
            }
        }, 500);
        
        setTimeout(() => clearInterval(checkInterval), 30000);
    };
    
    // é é¢è¼‰å…¥æ™‚è‡ªå‹•åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', window.initializeMultiTagSystem);
    } else {
        window.initializeMultiTagSystem();
    }
    
})();
</script>

<!-- ç³»çµ± 3: Placeholder é»æ“Šè™•ç†ç³»çµ± -->
<script>
/**
 * TinyMCE Placeholder é»æ“Šè™•ç†ç³»çµ±
 * åŠŸèƒ½ï¼šé»æ“Š placeholder é€²è¡Œç·¨è¼¯
 */

// å…¨å±€è®Šæ•¸
let activeInput = null;
let placeholderData = null;

// åˆå§‹åŒ– Placeholder è™•ç†
function initBubblePlaceholderHandler() {
    console.log('[Placeholder-Handler] é–‹å§‹åˆå§‹åŒ–...');
    
    if (typeof tinymce === 'undefined') {
        setTimeout(initBubblePlaceholderHandler, 100);
        return;
    }
    
    // è™•ç†ç·¨è¼¯å™¨
    tinymce.on('AddEditor', function(e) {
        e.editor.on('init', function() {
            setupPlaceholderHandler(e.editor);
        });
    });
    
    // è™•ç†å·²å­˜åœ¨çš„ç·¨è¼¯å™¨
    if (tinymce.get()) {
        tinymce.get().forEach(editor => {
            if (editor.initialized) {
                setupPlaceholderHandler(editor);
            }
        });
    }
}

// è¨­ç½®è™•ç†å™¨
function setupPlaceholderHandler(editor) {
    if (editor.placeholderHandlerSetup) return;
    editor.placeholderHandlerSetup = true;
    
    console.log('[Placeholder-Handler] è¨­ç½®ç·¨è¼¯å™¨:', editor.id);
    
    // æ·»åŠ ç·¨è¼¯æ™‚çš„æ¨£å¼
    editor.dom.addStyle(`
        .editing-placeholder {
            background-color: #fff !important;
            border: 2px solid #721c24 !important;
            padding: 6px 10px !important;
            border-radius: 3px !important;
            color: #721c24 !important;
            font-style: normal !important;
            font-size: inherit !important;
            min-width: 80px !important;
            display: inline-block !important;
            vertical-align: middle !important;
            outline: none !important;
        }
        .opt-improvement {
            border-bottom: 2px solid #10B981 !important;  /* ç¶ è‰²åº•ç·š */
            color: #065F46 !important;                    /* æ·±ç¶ è‰²æ–‡å­— */
            padding-bottom: 1px !important;
            font-weight: 500 !important;
            display: inline !important;
            background-color: transparent !important;
            border-radius: 0 !important;
        }
    `);
    
    // è¨­ç½®é»æ“Šè™•ç†
    const editorBody = editor.getBody();
    if (editorBody) {
        // ä½¿ç”¨ capture phase æ•ç²é»æ“Š
        editorBody.addEventListener('mousedown', function(e) {
            handlePlaceholderClick(e, editor);
        }, true);
        
        console.log('[Placeholder-Handler] é»æ“Šè™•ç†å™¨å·²è¨­ç½®');
    }
    
    // ç›£è½éµç›¤
    editor.on('keydown', function(e) {
        if (activeInput) {
            if (e.key === 'Enter') {
                e.preventDefault();
                finishEditingPlaceholder(editor);
            } else if (e.key === 'Escape') {
                e.preventDefault();
                cancelEditingPlaceholder(editor);
            }
        }
    });
}

// è™•ç†é»æ“Š
function handlePlaceholderClick(e, editor) {
    const target = e.target;
    
    if (target && target.classList && target.classList.contains('opt-placeholder')) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('[Placeholder-Handler] é»æ“Š placeholder:', target.innerText);
        
        // å¦‚æœæ²’æœ‰æ­£åœ¨ç·¨è¼¯çš„ placeholder
        if (!activeInput) {
            startEditingPlaceholder(target, editor);
        }
    }
    // é»æ“Šå…¶ä»–åœ°æ–¹
    else if (activeInput && !target.classList.contains('editing-placeholder')) {
        finishEditingPlaceholder(editor);
    }
}

// é–‹å§‹ç·¨è¼¯
function startEditingPlaceholder(placeholder, editor) {
    // ä¿å­˜è³‡æ–™
    placeholderData = {
        text: placeholder.innerText,
        type: placeholder.innerText.replace(/[\[\]]/g, '')
    };
    
    console.log('[Placeholder-Handler] é–‹å§‹ç·¨è¼¯:', placeholderData.type);
    
    // è½‰æ›æ¨£å¼
    placeholder.classList.remove('opt-placeholder');
    placeholder.classList.add('editing-placeholder');
    placeholder.contentEditable = 'true';
    
    // è¨­ç½®åˆå§‹å€¼æç¤ºï¼ˆæ ¹æ“šé¡å‹ï¼‰
    const hints = {
        'PERCENTAGE': '25',
        'TEAM SIZE': '5-10',
        'AMOUNT': '1000',
        'NUMBER': '100',
        'TIME PERIOD': '3',
        'USER COUNT': '10000',
        '35M units': '35',
        '70%': '70'
    };
    
    placeholder.innerText = hints[placeholderData.type] || '';
    activeInput = placeholder;
    
    // èšç„¦ä¸¦é¸ä¸­å…¨éƒ¨
    setTimeout(() => {
        placeholder.focus();
        // é¸ä¸­å…¨éƒ¨å…§å®¹
        const range = editor.getDoc().createRange();
        range.selectNodeContents(placeholder);
        const sel = editor.getWin().getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    }, 100);
}

// å®Œæˆç·¨è¼¯
function finishEditingPlaceholder(editor) {
    if (!activeInput || !placeholderData) return;
    
    const value = activeInput.innerText.trim();
    console.log('[Placeholder-Handler] å®Œæˆç·¨è¼¯:', value);
    
    if (value) {
        // æ ¼å¼åŒ–è¼¸å…¥å€¼ï¼ˆæ ¹æ“š placeholder é¡å‹æ·»åŠ å–®ä½ï¼‰
        let formatted = value;
        
        switch(placeholderData.type) {
            case 'PERCENTAGE':
            case '70%':
                // ç§»é™¤ç¾æœ‰çš„ % ç¬¦è™Ÿï¼Œç„¶å¾Œæ·»åŠ 
                formatted = value.replace(/%/g, '').trim();
                if (formatted && !isNaN(formatted)) {
                    formatted = formatted + '%';
                }
                break;
                
            case 'AMOUNT':
                // æª¢æŸ¥æ˜¯å¦å·²æœ‰è²¨å¹£ç¬¦è™Ÿ
                if (!value.match(/[$Â¥â‚¬Â£]/)) {
                    // å¦‚æœæ˜¯ç´”æ•¸å­—ï¼Œæ·»åŠ  $
                    const numValue = value.replace(/[^0-9.KMB]/gi, '');
                    if (numValue) {
                        formatted = '$' + value;
                    }
                }
                break;
                
            case 'TEAM SIZE':
                // å¦‚æœè¼¸å…¥çš„æ˜¯ç´”æ•¸å­—ï¼ŒåŠ ä¸Š "people"
                if (value.match(/^\d+$/)) {
                    formatted = value + ' people';
                } else if (value.match(/^\d+-\d+$/)) {
                    formatted = value + ' people';
                }
                break;
                
            case 'TIME PERIOD':
                // æª¢æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ™‚é–“å–®ä½
                if (value.match(/^\d+$/)) {
                    formatted = value + ' months';
                }
                break;
                
            case 'USER COUNT':
                // è™•ç†ç”¨æˆ¶æ•¸é‡ï¼Œä¾‹å¦‚ 10K, 1M ç­‰
                if (value.match(/^\d+$/)) {
                    const num = parseInt(value);
                    if (num >= 1000000) {
                        formatted = (num / 1000000).toFixed(1) + 'M';
                    } else if (num >= 1000) {
                        formatted = (num / 1000).toFixed(1) + 'K';
                    }
                }
                break;
                
            case '35M units':
                // è™•ç†å–®ä½æ•¸é‡
                if (value.match(/^\d+$/)) {
                    formatted = value + 'M units';
                }
                break;
        }
        
        console.log('[Placeholder-Handler] æ ¼å¼åŒ–çµæœ:', formatted);
        
        // ç§»é™¤ç·¨è¼¯æ¨£å¼ï¼Œæ·»åŠ å®Œæˆæ¨£å¼
        activeInput.classList.remove('editing-placeholder');
        activeInput.classList.add('opt-improvement');
        activeInput.contentEditable = 'false';
        activeInput.innerText = formatted;
    } else {
        // æ¢å¾©åŸç‹€
        activeInput.classList.remove('editing-placeholder');
        activeInput.classList.add('opt-placeholder');
        activeInput.contentEditable = 'false';
        activeInput.innerText = placeholderData.text;
    }
    
    // è§¸ç™¼å…§å®¹æ›´æ–°
    editor.fire('change');
    editor.save();
    
    // é‡ç½®
    activeInput = null;
    placeholderData = null;
}

// å–æ¶ˆç·¨è¼¯
function cancelEditingPlaceholder(editor) {
    if (!activeInput || !placeholderData) return;
    
    console.log('[Placeholder-Handler] å–æ¶ˆç·¨è¼¯');
    
    // æ¢å¾©åŸç‹€
    activeInput.classList.remove('editing-placeholder');
    activeInput.classList.add('opt-placeholder');
    activeInput.contentEditable = 'false';
    activeInput.innerText = placeholderData.text;
    
    // é‡ç½®
    activeInput = null;
    placeholderData = null;
}

// è‡ªå‹•åˆå§‹åŒ–
setTimeout(initBubblePlaceholderHandler, 1000);
</script>