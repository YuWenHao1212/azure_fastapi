<!-- å¤šæ¨™è¨˜ç¨ç«‹æ§åˆ¶ç³»çµ± - æ·»åŠ åˆ° Page HTML Header -->

<script>
/**
 * å¤šæ¨™è¨˜ç¨ç«‹æ§åˆ¶ç³»çµ±
 * å¯ä»¥åˆ†åˆ¥æ§åˆ¶5ç¨®ä¸åŒçš„ opt-tag é¡¯ç¤º/éš±è—
 */

(function() {
    'use strict';
    
    // å®šç¾©5ç¨®æ¨™è¨˜é¡å‹
    window.tagTypes = {
        'opt-new': {
            name: 'æ–°å¢å€æ®µ',
            color: 'green',
            visible: true
        },
        'opt-modified': {
            name: 'ä¿®æ”¹å…§å®¹',
            color: 'yellow',
            visible: true
        },
        'opt-placeholder': {
            name: 'ä½”ä½ç¬¦',
            color: 'red',
            visible: true
        },
        'opt-keyword': {
            name: 'æ–°é—œéµå­—',
            color: 'purple',
            visible: true
        },
        'opt-keyword-existing': {
            name: 'ç¾æœ‰é—œéµå­—',
            color: 'blue',
            visible: true
        }
    };
    
    // æ³¨å…¥å¤šæ¨™è¨˜æ§åˆ¶æ¨£å¼
    window.injectMultiTagStyles = function() {
        try {
            if (typeof tinymce === 'undefined' || !tinymce.activeEditor) {
                console.log('â³ TinyMCE å°šæœªæº–å‚™å¥½');
                return false;
            }
            
            const editor = tinymce.activeEditor;
            const iframeDoc = editor.getDoc();
            
            // æª¢æŸ¥æ˜¯å¦å·²æ³¨å…¥
            if (iframeDoc.getElementById('multi-tag-styles')) {
                console.log('âœ… æ¨£å¼å·²å­˜åœ¨');
                return true;
            }
            
            const style = iframeDoc.createElement('style');
            style.id = 'multi-tag-styles';
            style.textContent = `
                /* === é è¨­æ¨£å¼ - æ‰€æœ‰æ¨™è¨˜å¯è¦‹ === */
                
                /* opt-new - æ–°å¢å€æ®µ (ç¶ è‰²) */
                .opt-new {
                    background-color: rgba(16, 185, 129, 0.1) !important;
                    border-left: 4px solid #10B981 !important;
                    padding-left: 16px !important;
                    margin: 4px 0 !important;
                    transition: all 0.3s ease;
                }
                
                /* opt-modified - ä¿®æ”¹å…§å®¹ (é»ƒè‰²) */
                .opt-modified {
                    background-color: #fef3c7 !important;
                    padding: 2px 6px !important;
                    border-radius: 3px !important;
                    transition: all 0.3s ease;
                }
                
                /* opt-placeholder - ä½”ä½ç¬¦ (ç´…è‰²) */
                .opt-placeholder {
                    background-color: #fee2e2 !important;
                    color: #991b1b !important;
                    border: 1px dashed #f87171 !important;
                    padding: 2px 8px !important;
                    border-radius: 4px !important;
                    font-style: italic !important;
                    transition: all 0.3s ease;
                }
                
                /* opt-keyword - æ–°é—œéµå­— (ç´«è‰²) */
                .opt-keyword {
                    background-color: transparent !important;
                    color: #6366f1 !important;
                    border: 1px solid #c7d2fe !important;
                    padding: 2px 6px !important;
                    border-radius: 3px !important;
                    font-weight: 500 !important;
                    transition: all 0.3s ease;
                }
                
                /* opt-keyword-existing - ç¾æœ‰é—œéµå­— (è—è‰²) */
                .opt-keyword-existing {
                    background-color: #2563eb !important;
                    color: white !important;
                    padding: 3px 8px !important;
                    border-radius: 4px !important;
                    font-weight: 600 !important;
                    transition: all 0.3s ease;
                }
                
                /* === å€‹åˆ¥éš±è—æ¨£å¼ === */
                
                /* éš±è— opt-new */
                body.hide-opt-new .opt-new {
                    background-color: transparent !important;
                    border: none !important;
                    padding: 0 !important;
                    margin: 0 !important;
                }
                
                /* éš±è— opt-modified */
                body.hide-opt-modified .opt-modified {
                    background-color: transparent !important;
                    padding: 0 !important;
                    border-radius: 0 !important;
                }
                
                /* éš±è— opt-placeholder */
                body.hide-opt-placeholder .opt-placeholder {
                    background-color: transparent !important;
                    color: inherit !important;
                    border: none !important;
                    padding: 0 !important;
                    font-style: normal !important;
                }
                
                /* éš±è— opt-keyword */
                body.hide-opt-keyword .opt-keyword {
                    background-color: transparent !important;
                    color: inherit !important;
                    border: none !important;
                    padding: 0 !important;
                    font-weight: normal !important;
                }
                
                /* éš±è— opt-keyword-existing */
                body.hide-opt-keyword-existing .opt-keyword-existing {
                    background-color: transparent !important;
                    color: inherit !important;
                    padding: 0 !important;
                    font-weight: normal !important;
                    border-radius: 0 !important;
                }
            `;
            
            iframeDoc.head.appendChild(style);
            console.log('âœ… å¤šæ¨™è¨˜æ¨£å¼å·²æ³¨å…¥');
            return true;
            
        } catch (error) {
            console.error('âŒ æ³¨å…¥æ¨£å¼æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            return false;
        }
    };
    
    /**
     * åˆ‡æ›å–®å€‹æ¨™è¨˜é¡å‹çš„é¡¯ç¤º/éš±è—
     * @param {string} tagType - æ¨™è¨˜é¡å‹ (å¦‚ 'opt-new')
     * @param {boolean} show - true é¡¯ç¤º, false éš±è—
     */
    window.toggleSingleTag = function(tagType, show) {
        try {
            if (typeof tinymce === 'undefined' || !tinymce.activeEditor) {
                console.error('âŒ TinyMCE ç·¨è¼¯å™¨æœªæ‰¾åˆ°');
                return false;
            }
            
            const editor = tinymce.activeEditor;
            const iframeDoc = editor.getDoc();
            const body = iframeDoc.body;
            
            // ç¢ºä¿æ¨£å¼å·²æ³¨å…¥
            if (!iframeDoc.getElementById('multi-tag-styles')) {
                window.injectMultiTagStyles();
            }
            
            const hideClass = `hide-${tagType}`;
            
            if (show) {
                body.classList.remove(hideClass);
                console.log(`ğŸŸ¢ é¡¯ç¤º ${tagType}`);
            } else {
                body.classList.add(hideClass);
                console.log(`ğŸ”´ éš±è— ${tagType}`);
            }
            
            // æ›´æ–°ç‹€æ…‹
            if (window.tagTypes[tagType]) {
                window.tagTypes[tagType].visible = show;
            }
            
            // è¼•é‡ç´šåˆ·æ–°
            body.style.opacity = '0.99';
            setTimeout(() => {
                body.style.opacity = '1';
            }, 10);
            
            return true;
            
        } catch (error) {
            console.error('âŒ åˆ‡æ›æ¨™è¨˜æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            return false;
        }
    };
    
    /**
     * é¡¯ç¤ºæ‰€æœ‰æ¨™è¨˜
     */
    window.showAllTags = function() {
        Object.keys(window.tagTypes).forEach(tagType => {
            window.toggleSingleTag(tagType, true);
        });
        console.log('âœ… é¡¯ç¤ºæ‰€æœ‰æ¨™è¨˜');
    };
    
    /**
     * éš±è—æ‰€æœ‰æ¨™è¨˜
     */
    window.hideAllTags = function() {
        Object.keys(window.tagTypes).forEach(tagType => {
            window.toggleSingleTag(tagType, false);
        });
        console.log('âœ… éš±è—æ‰€æœ‰æ¨™è¨˜');
    };
    
    /**
     * åˆå§‹åŒ–å¤šæ¨™è¨˜ç³»çµ±
     */
    window.initializeMultiTagSystem = function() {
        console.log('ğŸš€ åˆå§‹åŒ–å¤šæ¨™è¨˜æ§åˆ¶ç³»çµ±...');
        
        const checkInterval = setInterval(function() {
            if (typeof tinymce !== 'undefined' && tinymce.activeEditor) {
                if (window.injectMultiTagStyles()) {
                    clearInterval(checkInterval);
                    console.log('âœ… å¤šæ¨™è¨˜ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
                }
            }
        }, 500);
        
        setTimeout(() => clearInterval(checkInterval), 30000);
    };
    
    // é é¢è¼‰å…¥æ™‚è‡ªå‹•åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', window.initializeMultiTagSystem);
    } else {
        window.initializeMultiTagSystem();
    }
    
})();
</script>