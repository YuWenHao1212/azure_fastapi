<!-- å®Œæ•´çš„ Bubble HTML Element å…§å®¹ - ç›´æ¥è¤‡è£½è²¼ä¸Šåˆ° Bubble -->
<div id="tinymce-debugger" style="
    background: white;
    border: 2px solid #333;
    border-radius: 8px;
    padding: 20px;
    max-height: 400px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 12px;
">
    <h3 style="margin: 0 0 10px 0; font-size: 14px;">ğŸ” TinyMCE é™¤éŒ¯å·¥å…·</h3>
    
    <div style="margin-bottom: 10px;">
        <button id="btn-identify" style="
            background: #2563EB;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
        ">è­˜åˆ¥ç·¨è¼¯å™¨</button>
        
        <button id="btn-check" style="
            background: #2563EB;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
        ">æª¢æŸ¥æ¨£å¼</button>
        
        <button id="btn-inject" style="
            background: #10B981;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
        ">æ³¨å…¥æ¨£å¼</button>
        
        <button id="btn-clear" style="
            background: #EF4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
        ">æ¸…é™¤</button>
    </div>
    
    <div id="debug-output" style="
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        white-space: pre-wrap;
        word-wrap: break-word;
        min-height: 100px;
        max-height: 300px;
        overflow-y: auto;
    ">ç­‰å¾…æ“ä½œ...</div>
</div>

<script>
(function() {
    // é™¤éŒ¯å·¥å…·ç‰©ä»¶
    const debugTool = {
        output: null,
        
        init: function() {
            this.output = document.getElementById('debug-output');
            if (!this.output) {
                console.error('æ‰¾ä¸åˆ° debug-output å…ƒç´ ');
                return;
            }
            
            // ç¶å®šäº‹ä»¶
            document.getElementById('btn-identify').addEventListener('click', () => this.identify());
            document.getElementById('btn-check').addEventListener('click', () => this.checkStyles());
            document.getElementById('btn-inject').addEventListener('click', () => this.inject());
            document.getElementById('btn-clear').addEventListener('click', () => this.clear());
            
            this.log('é™¤éŒ¯å·¥å…·å·²è¼‰å…¥', 'info');
            
            // è‡ªå‹•è­˜åˆ¥ç·¨è¼¯å™¨
            setTimeout(() => {
                this.log('è‡ªå‹•æƒæç·¨è¼¯å™¨...', 'info');
                this.identify();
            }, 2000);
        },
        
        log: function(message, type = 'info') {
            if (!this.output) {
                console.log(message);
                return;
            }
            
            const time = new Date().toLocaleTimeString('zh-TW');
            const colors = {
                'info': '#3B82F6',
                'success': '#10B981',
                'warning': '#F59E0B',
                'error': '#EF4444'
            };
            
            const line = document.createElement('div');
            line.style.color = colors[type] || '#000';
            line.style.marginBottom = '4px';
            line.textContent = `[${time}] ${message}`;
            
            this.output.appendChild(line);
            this.output.scrollTop = this.output.scrollHeight;
            
            // åŒæ™‚è¼¸å‡ºåˆ°æ§åˆ¶å°
            console.log(`[TinyMCE Debug] ${message}`);
        },
        
        clear: function() {
            if (this.output) {
                this.output.innerHTML = '';
                this.log('æ—¥èªŒå·²æ¸…é™¤', 'info');
            }
        },
        
        identify: function() {
            this.log('========== è­˜åˆ¥ TinyMCE ç·¨è¼¯å™¨ ==========', 'info');
            
            if (typeof tinymce === 'undefined') {
                this.log('éŒ¯èª¤: TinyMCE æœªè¼‰å…¥ï¼è«‹ç¢ºèªé é¢å·²å®Œå…¨è¼‰å…¥ã€‚', 'error');
                this.log('æç¤º: å¯èƒ½éœ€è¦ç­‰å¾…æ›´é•·æ™‚é–“ï¼Œæˆ–æª¢æŸ¥ TinyMCE æ˜¯å¦æ­£ç¢ºåˆå§‹åŒ–', 'warning');
                return;
            }
            
            const editors = tinymce.editors;
            this.log(`æ‰¾åˆ° ${editors.length} å€‹ TinyMCE ç·¨è¼¯å™¨`, editors.length > 0 ? 'success' : 'warning');
            
            if (editors.length === 0) {
                this.log('æ²’æœ‰æ‰¾åˆ°ä»»ä½•ç·¨è¼¯å™¨ï¼Œè«‹ç¢ºèªï¼š', 'warning');
                this.log('1. TinyMCE ç·¨è¼¯å™¨æ˜¯å¦å·²ç¶“æ·»åŠ åˆ°é é¢', 'warning');
                this.log('2. ç·¨è¼¯å™¨æ˜¯å¦å·²ç¶“åˆå§‹åŒ–å®Œæˆ', 'warning');
                return;
            }
            
            editors.forEach((editor, idx) => {
                const isReadOnly = editor.mode.get() === 'readonly';
                this.log(`\nç·¨è¼¯å™¨ ${idx + 1}:`, 'info');
                this.log(`  ID: ${editor.id}`, 'info');
                this.log(`  ç‹€æ…‹: ${editor.initialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}`, editor.initialized ? 'success' : 'warning');
                this.log(`  æ¨¡å¼: ${editor.mode.get()} ${isReadOnly ? '(å”¯è®€)' : '(å¯ç·¨è¼¯)'}`, 'info');
                this.log(`  å¯è¦‹: ${!editor.isHidden() ? 'æ˜¯' : 'å¦'}`, 'info');
                
                // ç‰¹åˆ¥æ¨™è¨˜å·²çŸ¥çš„ç·¨è¼¯å™¨
                if (editor.id === 'TinyMCE_Editor') {
                    this.log('  â†’ é€™æ˜¯åŸå§‹ç·¨è¼¯å™¨ (å¯ç·¨è¼¯)', 'success');
                } else if (editor.id === 'TinyMCE_Editor_initial_resume') {
                    this.log('  â†’ é€™æ˜¯åˆå§‹å±¥æ­·ç·¨è¼¯å™¨ (å”¯è®€)', 'success');
                }
            });
            
            // æª¢æŸ¥ç‰¹å®šç·¨è¼¯å™¨
            this.log('\næª¢æŸ¥ç‰¹å®šç·¨è¼¯å™¨å­˜åœ¨æ€§:', 'info');
            const editor1 = tinymce.get('TinyMCE_Editor');
            const editor2 = tinymce.get('TinyMCE_Editor_initial_resume');
            
            this.log(`TinyMCE_Editor: ${editor1 ? 'âœ“ å­˜åœ¨' : 'âœ— ä¸å­˜åœ¨'}`, 
                     editor1 ? 'success' : 'error');
            this.log(`TinyMCE_Editor_initial_resume: ${editor2 ? 'âœ“ å­˜åœ¨' : 'âœ— ä¸å­˜åœ¨'}`, 
                     editor2 ? 'success' : 'error');
        },
        
        checkStyles: function() {
            this.log('========== æª¢æŸ¥æ¨£å¼ç‹€æ…‹ ==========', 'info');
            
            if (!tinymce || !tinymce.editors || tinymce.editors.length === 0) {
                this.log('éŒ¯èª¤: æ²’æœ‰æ‰¾åˆ° TinyMCE ç·¨è¼¯å™¨', 'error');
                return;
            }
            
            const targetClasses = [
                'opt-keyword',
                'opt-keyword-existing',
                'opt-modified',
                'opt-new',
                'opt-placeholder',
                'opt-improvement'
            ];
            
            tinymce.editors.forEach((editor) => {
                this.log(`\næª¢æŸ¥ç·¨è¼¯å™¨: ${editor.id}`, 'info');
                
                if (!editor.getBody()) {
                    this.log('  ç·¨è¼¯å™¨ä¸»é«”æœªè¼‰å…¥', 'warning');
                    return;
                }
                
                // æª¢æŸ¥æ˜¯å¦æœ‰æ³¨å…¥æ¨™è¨˜
                const hasStyles = editor.dom.hasClass(editor.getBody(), 'styles-injected');
                this.log(`  æ¨£å¼æ³¨å…¥æ¨™è¨˜: ${hasStyles ? 'âœ“ å·²æ³¨å…¥' : 'âœ— æœªæ³¨å…¥'}`, 
                         hasStyles ? 'success' : 'warning');
                
                // æª¢æŸ¥å„å€‹æ¨£å¼é¡åˆ¥
                let totalElements = 0;
                targetClasses.forEach(className => {
                    const elements = editor.dom.select('.' + className);
                    if (elements.length > 0) {
                        totalElements += elements.length;
                        this.log(`  .${className}: æ‰¾åˆ° ${elements.length} å€‹å…ƒç´ `, 'info');
                        
                        // æª¢æŸ¥ç¬¬ä¸€å€‹å…ƒç´ çš„æ¨£å¼
                        if (elements[0]) {
                            const styles = editor.getWin().getComputedStyle(elements[0]);
                            this.log(`    - èƒŒæ™¯: ${styles.backgroundColor}`, 'info');
                            this.log(`    - é¡è‰²: ${styles.color}`, 'info');
                        }
                    }
                });
                
                if (totalElements === 0) {
                    this.log('  æ²’æœ‰æ‰¾åˆ°ä»»ä½•æ¨™è¨˜å…ƒç´ ', 'warning');
                }
                
                // æª¢æŸ¥ style æ¨™ç±¤
                const styleElements = editor.dom.select('style');
                this.log(`  <style> æ¨™ç±¤æ•¸é‡: ${styleElements.length}`, 'info');
            });
        },
        
        inject: function() {
            this.log('========== æ³¨å…¥æ¨£å¼åˆ°æ‰€æœ‰ç·¨è¼¯å™¨ ==========', 'info');
            
            if (!tinymce || !tinymce.editors || tinymce.editors.length === 0) {
                this.log('éŒ¯èª¤: æ²’æœ‰æ‰¾åˆ° TinyMCE ç·¨è¼¯å™¨', 'error');
                return;
            }
            
            // å®Œæ•´çš„æ¨£å¼å®šç¾©
            const fullCSS = `
                /* åŸæœ‰é—œéµå­— - æ·±è—è‰²èƒŒæ™¯ */
                span.opt-keyword-existing {
                    background-color: #2563EB !important;
                    color: #FFFFFF !important;
                    padding: 3px 8px !important;
                    border-radius: 4px !important;
                    font-weight: 600 !important;
                    margin: 0 2px !important;
                    box-shadow: 0 1px 2px rgba(37, 99, 235, 0.3) !important;
                }
                
                /* æ–°å¢é—œéµå­— - ç´«è‰²é‚Šæ¡† */
                span.opt-keyword {
                    background-color: transparent !important;
                    color: #6366F1 !important;
                    border: 1px solid #C7D2FE !important;
                    padding: 2px 6px !important;
                    border-radius: 3px !important;
                    font-weight: 500 !important;
                    margin: 0 2px !important;
                }
                
                /* ä¿®æ”¹å…§å®¹ - æ·ºé»ƒè‰²èƒŒæ™¯ */
                span.opt-modified {
                    background-color: #FFF3CD !important;
                    padding: 2px 6px !important;
                    border-radius: 3px !important;
                    display: inline !important;
                }
                
                /* æ–°å¢å…§å®¹ - ç¶ è‰²å·¦é‚Šæ¡† */
                .opt-new {
                    border-left: 4px solid #10B981 !important;
                    padding-left: 16px !important;
                    background-color: rgba(209, 250, 229, 0.1) !important;
                    margin-left: -20px !important;
                    padding-right: 16px !important;
                }
                
                /* ä½”ä½ç¬¦ - ç´…è‰²è™›ç·šæ¡† */
                span.opt-placeholder {
                    background-color: #FEE2E2 !important;
                    color: #991B1B !important;
                    border: 1px dashed #F87171 !important;
                    padding: 2px 8px !important;
                    border-radius: 4px !important;
                    font-style: italic !important;
                    font-weight: 500 !important;
                    cursor: pointer !important;
                    margin: 0 2px !important;
                }
                
                /* å·²ç·¨è¼¯å…§å®¹ - ç¶ è‰²åº•ç·š */
                span.opt-improvement {
                    border-bottom: 2px solid #10B981 !important;
                    color: #065F46 !important;
                    padding-bottom: 1px !important;
                    font-weight: 500 !important;
                }
            `;
            
            let successCount = 0;
            let failCount = 0;
            
            tinymce.editors.forEach(editor => {
                try {
                    if (!editor.initialized) {
                        this.log(`è·³éæœªåˆå§‹åŒ–çš„ç·¨è¼¯å™¨: ${editor.id}`, 'warning');
                        return;
                    }
                    
                    // æ³¨å…¥æ¨£å¼
                    editor.dom.addStyle(fullCSS);
                    
                    // æ·»åŠ æ¨™è¨˜
                    editor.dom.addClass(editor.getBody(), 'styles-injected');
                    
                    successCount++;
                    this.log(`âœ“ æˆåŠŸæ³¨å…¥æ¨£å¼åˆ°: ${editor.id}`, 'success');
                    
                } catch (error) {
                    failCount++;
                    this.log(`âœ— æ³¨å…¥å¤±æ•— (${editor.id}): ${error.message}`, 'error');
                }
            });
            
            this.log(`\nç¸½çµ: æˆåŠŸ ${successCount} å€‹, å¤±æ•— ${failCount} å€‹`, 
                     failCount === 0 ? 'success' : 'warning');
            
            if (successCount > 0) {
                this.log('æç¤º: æ¨£å¼å·²æ³¨å…¥ï¼Œè«‹æª¢æŸ¥ç·¨è¼¯å™¨å…§å®¹æ˜¯å¦æ­£ç¢ºé¡¯ç¤º', 'info');
            }
        }
    };
    
    // ç­‰å¾… DOM è¼‰å…¥å®Œæˆ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => debugTool.init());
    } else {
        // DOM å·²ç¶“è¼‰å…¥å®Œæˆ
        setTimeout(() => debugTool.init(), 100);
    }
    
    // å°‡å·¥å…·æš´éœ²åˆ°å…¨å±€ï¼ˆæ–¹ä¾¿æ‰‹å‹•èª¿ç”¨ï¼‰
    window.tinyMCEDebugTool = debugTool;
})();
</script>