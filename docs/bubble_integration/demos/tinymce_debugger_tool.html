<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinyMCE å¤šç·¨è¼¯å™¨é™¤éŒ¯å·¥å…·</title>
    <style>
        #tinymce-debugger {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-family: monospace;
            font-size: 12px;
            z-index: 10000;
        }
        
        #tinymce-debugger.minimized {
            max-height: 50px;
            overflow: hidden;
        }
        
        #tinymce-debugger h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
        }
        
        #tinymce-debugger button {
            background: #2563EB;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
            font-size: 11px;
        }
        
        #tinymce-debugger button:hover {
            background: #1D4ED8;
        }
        
        #tinymce-debugger .log-section {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        #tinymce-debugger .success {
            color: #10B981;
            font-weight: bold;
        }
        
        #tinymce-debugger .error {
            color: #EF4444;
            font-weight: bold;
        }
        
        #tinymce-debugger .warning {
            color: #F59E0B;
            font-weight: bold;
        }
        
        #tinymce-debugger .info {
            color: #3B82F6;
        }
        
        #tinymce-debugger .editor-info {
            border-left: 3px solid #3B82F6;
            padding-left: 10px;
            margin: 10px 0;
        }
        
        #tinymce-debugger .minimize-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #6B7280;
            padding: 2px 8px;
            font-size: 10px;
        }
        
        #tinymce-debugger .clear-btn {
            background: #EF4444;
        }
        
        #tinymce-debugger .readonly-badge {
            background: #FEF3C7;
            color: #92400E;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    
<!-- TinyMCE é™¤éŒ¯å·¥å…· HTML å…ƒä»¶ -->
<div id="tinymce-debugger">
    <button class="minimize-btn" onclick="toggleDebugger()">æœ€å°åŒ–</button>
    <h3>ğŸ” TinyMCE å¤šç·¨è¼¯å™¨é™¤éŒ¯å·¥å…·</h3>
    
    <div class="button-group">
        <button onclick="identifyAllEditors()">1. è­˜åˆ¥æ‰€æœ‰ç·¨è¼¯å™¨</button>
        <button onclick="checkEditorStyles()">2. æª¢æŸ¥æ¨£å¼ç‹€æ…‹</button>
        <button onclick="injectStylesToAll()">3. æ³¨å…¥æ¨£å¼åˆ°æ‰€æœ‰ç·¨è¼¯å™¨</button>
        <button onclick="testSpecificEditor()">4. æ¸¬è©¦ç‰¹å®šç·¨è¼¯å™¨</button>
        <button onclick="monitorEditorChanges()">5. ç›£æ§ç·¨è¼¯å™¨è®ŠåŒ–</button>
        <button class="clear-btn" onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
    </div>
    
    <div id="debug-log" class="log-section">
        <div class="info">é™¤éŒ¯å·¥å…·å·²è¼‰å…¥ã€‚é»æ“ŠæŒ‰éˆ•é–‹å§‹è¨ºæ–·...</div>
    </div>
</div>

<script>
// é™¤éŒ¯å·¥å…·å‡½æ•¸
let logElement = null;
let monitorInterval = null;

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    logElement = document.getElementById('debug-log');
    log('info', 'é™¤éŒ¯å·¥å…·å·²åˆå§‹åŒ–');
    
    // è‡ªå‹•åŸ·è¡Œåˆå§‹è¨ºæ–·
    setTimeout(function() {
        log('info', 'é–‹å§‹è‡ªå‹•è¨ºæ–·...');
        identifyAllEditors();
    }, 2000);
});

// æ—¥èªŒå‡½æ•¸
function log(type, message) {
    if (!logElement) return;
    
    const timestamp = new Date().toLocaleTimeString('zh-TW');
    const logEntry = document.createElement('div');
    logEntry.className = type;
    logEntry.textContent = `[${timestamp}] ${message}`;
    logElement.appendChild(logEntry);
    
    // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
    logElement.scrollTop = logElement.scrollHeight;
    
    // åŒæ™‚è¼¸å‡ºåˆ°æ§åˆ¶å°
    console.log(`[TinyMCE Debugger] ${message}`);
}

// æ¸…é™¤æ—¥èªŒ
function clearLog() {
    if (logElement) {
        logElement.innerHTML = '<div class="info">æ—¥èªŒå·²æ¸…é™¤</div>';
    }
}

// åˆ‡æ›æœ€å°åŒ–
function toggleDebugger() {
    const debugger = document.getElementById('tinymce-debugger');
    debugger.classList.toggle('minimized');
}

// 1. è­˜åˆ¥æ‰€æœ‰ç·¨è¼¯å™¨
function identifyAllEditors() {
    log('info', '========== è­˜åˆ¥ TinyMCE ç·¨è¼¯å™¨ ==========');
    
    if (typeof tinymce === 'undefined') {
        log('error', 'TinyMCE æœªè¼‰å…¥ï¼è«‹ç¢ºèªé é¢å·²å®Œå…¨è¼‰å…¥ã€‚');
        return;
    }
    
    const editors = tinymce.editors;
    log('success', `æ‰¾åˆ° ${editors.length} å€‹ TinyMCE ç·¨è¼¯å™¨`);
    
    editors.forEach((editor, index) => {
        const editorInfo = document.createElement('div');
        editorInfo.className = 'editor-info';
        
        const isReadOnly = editor.mode.get() === 'readonly';
        const readOnlyBadge = isReadOnly ? '<span class="readonly-badge">å”¯è®€</span>' : '';
        
        editorInfo.innerHTML = `
<strong>ç·¨è¼¯å™¨ ${index + 1}:</strong>
ID: ${editor.id} ${readOnlyBadge}
ç‹€æ…‹: ${editor.initialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}
å¯è¦‹: ${!editor.isHidden()}
æ¨¡å¼: ${editor.mode.get()}
å®¹å™¨: ${editor.container ? editor.container.id : 'N/A'}
        `;
        
        logElement.appendChild(editorInfo);
        
        // ç‰¹åˆ¥æ¨™è¨˜å·²çŸ¥çš„ç·¨è¼¯å™¨
        if (editor.id === 'TinyMCE_Editor') {
            log('info', 'â†’ é€™æ˜¯åŸå§‹ç·¨è¼¯å™¨ (å¯ç·¨è¼¯)');
        } else if (editor.id === 'TinyMCE_Editor_initial_resume') {
            log('info', 'â†’ é€™æ˜¯åˆå§‹å±¥æ­·ç·¨è¼¯å™¨ (å”¯è®€)');
        }
    });
    
    // æª¢æŸ¥ç‰¹å®šç·¨è¼¯å™¨
    log('info', '\næª¢æŸ¥ç‰¹å®šç·¨è¼¯å™¨å­˜åœ¨æ€§:');
    const originalEditor = tinymce.get('TinyMCE_Editor');
    const initialResumeEditor = tinymce.get('TinyMCE_Editor_initial_resume');
    
    log(originalEditor ? 'success' : 'warning', 
        `TinyMCE_Editor: ${originalEditor ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
    log(initialResumeEditor ? 'success' : 'warning', 
        `TinyMCE_Editor_initial_resume: ${initialResumeEditor ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
}

// 2. æª¢æŸ¥ç·¨è¼¯å™¨æ¨£å¼
function checkEditorStyles() {
    log('info', '========== æª¢æŸ¥ç·¨è¼¯å™¨æ¨£å¼ç‹€æ…‹ ==========');
    
    if (!tinymce || !tinymce.editors) {
        log('error', 'TinyMCE æœªè¼‰å…¥');
        return;
    }
    
    const targetClasses = [
        'opt-keyword',
        'opt-keyword-existing',
        'opt-modified',
        'opt-new',
        'opt-placeholder',
        'opt-improvement'
    ];
    
    tinymce.editors.forEach((editor, index) => {
        log('info', `\næª¢æŸ¥ç·¨è¼¯å™¨ ${index + 1} (${editor.id}):`);
        
        if (!editor.getBody()) {
            log('warning', 'ç·¨è¼¯å™¨ä¸»é«”æœªè¼‰å…¥');
            return;
        }
        
        // æª¢æŸ¥æ˜¯å¦æœ‰æ³¨å…¥æ¨™è¨˜
        const hasInjectedClass = editor.dom.hasClass(editor.getBody(), 'styles-injected');
        log(hasInjectedClass ? 'success' : 'warning', 
            `æ¨£å¼æ³¨å…¥æ¨™è¨˜: ${hasInjectedClass ? 'å·²æ³¨å…¥' : 'æœªæ³¨å…¥'}`);
        
        // æª¢æŸ¥å„å€‹æ¨£å¼é¡åˆ¥
        targetClasses.forEach(className => {
            const elements = editor.dom.select('.' + className);
            if (elements.length > 0) {
                log('info', `  ${className}: æ‰¾åˆ° ${elements.length} å€‹å…ƒç´ `);
                
                // æª¢æŸ¥ç¬¬ä¸€å€‹å…ƒç´ çš„è¨ˆç®—æ¨£å¼
                if (elements[0]) {
                    const styles = editor.getWin().getComputedStyle(elements[0]);
                    log('info', `    èƒŒæ™¯: ${styles.backgroundColor}`);
                    log('info', `    é¡è‰²: ${styles.color}`);
                }
            } else {
                log('info', `  ${className}: æœªæ‰¾åˆ°å…ƒç´ `);
            }
        });
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ¨£å¼æ¨™ç±¤
        const styleElements = editor.dom.select('style');
        log('info', `  æ‰¾åˆ° ${styleElements.length} å€‹ <style> æ¨™ç±¤`);
    });
}

// 3. æ³¨å…¥æ¨£å¼åˆ°æ‰€æœ‰ç·¨è¼¯å™¨
function injectStylesToAll() {
    log('info', '========== é–‹å§‹æ³¨å…¥æ¨£å¼ ==========');
    
    if (!tinymce || !tinymce.editors) {
        log('error', 'TinyMCE æœªè¼‰å…¥');
        return;
    }
    
    // æ¨£å¼å®šç¾©
    const fullCSS = `
        /* é—œéµå­—æ¨£å¼ */
        span.opt-keyword-existing {
            background-color: #2563EB !important;
            color: #FFFFFF !important;
            padding: 3px 8px !important;
            border-radius: 4px !important;
            font-weight: 600 !important;
            margin: 0 2px !important;
            box-shadow: 0 1px 2px rgba(37, 99, 235, 0.3) !important;
        }
        
        span.opt-keyword {
            background-color: transparent !important;
            color: #6366F1 !important;
            border: 1px solid #C7D2FE !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
            font-weight: 500 !important;
            margin: 0 2px !important;
        }
        
        span.opt-modified {
            background-color: #FFF3CD !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }
        
        .opt-new {
            border-left: 4px solid #10B981 !important;
            padding-left: 16px !important;
            background-color: rgba(209, 250, 229, 0.1) !important;
        }
        
        span.opt-placeholder {
            background-color: #FEE2E2 !important;
            color: #991B1B !important;
            border: 1px dashed #F87171 !important;
            padding: 2px 8px !important;
            border-radius: 4px !important;
            font-style: italic !important;
            cursor: pointer !important;
        }
    `;
    
    let successCount = 0;
    
    tinymce.editors.forEach((editor, index) => {
        try {
            if (!editor.initialized) {
                log('warning', `ç·¨è¼¯å™¨ ${editor.id} å°šæœªåˆå§‹åŒ–ï¼Œè·³é`);
                return;
            }
            
            // ç§»é™¤èˆŠçš„æ³¨å…¥æ¨™è¨˜
            if (editor.dom && editor.getBody()) {
                editor.dom.removeClass(editor.getBody(), 'styles-injected');
            }
            
            // æ³¨å…¥æ–°æ¨£å¼
            editor.dom.addStyle(fullCSS);
            editor.dom.addClass(editor.getBody(), 'styles-injected');
            
            successCount++;
            log('success', `âœ“ æˆåŠŸæ³¨å…¥æ¨£å¼åˆ°ç·¨è¼¯å™¨: ${editor.id}`);
            
        } catch (error) {
            log('error', `âœ— æ³¨å…¥å¤±æ•— (${editor.id}): ${error.message}`);
        }
    });
    
    log('info', `\nç¸½çµ: ${successCount}/${tinymce.editors.length} å€‹ç·¨è¼¯å™¨æˆåŠŸæ³¨å…¥æ¨£å¼`);
}

// 4. æ¸¬è©¦ç‰¹å®šç·¨è¼¯å™¨
function testSpecificEditor() {
    log('info', '========== æ¸¬è©¦ç‰¹å®šç·¨è¼¯å™¨ ==========');
    
    // æ¸¬è©¦åŸå§‹ç·¨è¼¯å™¨
    const originalEditor = tinymce.get('TinyMCE_Editor');
    if (originalEditor) {
        log('info', 'æ¸¬è©¦ TinyMCE_Editor (å¯ç·¨è¼¯):');
        testEditorWithContent(originalEditor, false);
    } else {
        log('warning', 'TinyMCE_Editor ä¸å­˜åœ¨');
    }
    
    // æ¸¬è©¦å”¯è®€ç·¨è¼¯å™¨
    const readOnlyEditor = tinymce.get('TinyMCE_Editor_initial_resume');
    if (readOnlyEditor) {
        log('info', '\næ¸¬è©¦ TinyMCE_Editor_initial_resume (å”¯è®€):');
        testEditorWithContent(readOnlyEditor, true);
    } else {
        log('warning', 'TinyMCE_Editor_initial_resume ä¸å­˜åœ¨');
    }
}

// æ¸¬è©¦ç·¨è¼¯å™¨å…§å®¹
function testEditorWithContent(editor, isReadOnly) {
    try {
        const testContent = `
<p>æ¸¬è©¦å…§å®¹ï¼š</p>
<ul>
    <li><span class="opt-keyword-existing">Python</span> é–‹ç™¼ç¶“é©—</li>
    <li><span class="opt-keyword">JavaScript</span> æŠ€èƒ½</li>
    <li><span class="opt-modified">5å¹´</span>å·¥ä½œç¶“é©—</li>
    <li class="opt-new">æ–°å¢çš„æŠ€èƒ½é …ç›®</li>
    <li>éœ€è¦ <span class="opt-placeholder">[å…·é«”æ•¸å­—]</span> é‡åŒ–</li>
</ul>
        `;
        
        if (!isReadOnly) {
            // å¯ç·¨è¼¯æ¨¡å¼ï¼šç›´æ¥è¨­ç½®å…§å®¹
            editor.setContent(testContent);
            log('success', 'å·²è¨­ç½®æ¸¬è©¦å…§å®¹');
        } else {
            // å”¯è®€æ¨¡å¼ï¼šåªæª¢æŸ¥ç¾æœ‰å…§å®¹
            const currentContent = editor.getContent();
            log('info', `ç•¶å‰å…§å®¹é•·åº¦: ${currentContent.length} å­—å…ƒ`);
            
            // æª¢æŸ¥æ˜¯å¦åŒ…å«æ¨£å¼é¡åˆ¥
            const hasOptClasses = currentContent.includes('opt-');
            log(hasOptClasses ? 'success' : 'info', 
                `åŒ…å«å„ªåŒ–æ¨™è¨˜: ${hasOptClasses ? 'æ˜¯' : 'å¦'}`);
        }
        
        // æª¢æŸ¥æ¨£å¼æ˜¯å¦æ­£ç¢ºæ¸²æŸ“
        setTimeout(() => {
            const body = editor.getBody();
            const keywordElements = body.querySelectorAll('.opt-keyword-existing');
            const modifiedElements = body.querySelectorAll('.opt-modified');
            
            log('info', `æ‰¾åˆ° ${keywordElements.length} å€‹ opt-keyword-existing å…ƒç´ `);
            log('info', `æ‰¾åˆ° ${modifiedElements.length} å€‹ opt-modified å…ƒç´ `);
            
            // æª¢æŸ¥ç¬¬ä¸€å€‹é—œéµå­—çš„æ¨£å¼
            if (keywordElements.length > 0) {
                const styles = editor.getWin().getComputedStyle(keywordElements[0]);
                log('info', `é—œéµå­—èƒŒæ™¯è‰²: ${styles.backgroundColor}`);
                log('info', `é—œéµå­—æ–‡å­—è‰²: ${styles.color}`);
            }
        }, 500);
        
    } catch (error) {
        log('error', `æ¸¬è©¦å¤±æ•—: ${error.message}`);
    }
}

// 5. ç›£æ§ç·¨è¼¯å™¨è®ŠåŒ–
function monitorEditorChanges() {
    if (monitorInterval) {
        clearInterval(monitorInterval);
        monitorInterval = null;
        log('info', 'å·²åœæ­¢ç›£æ§');
        return;
    }
    
    log('info', '========== é–‹å§‹ç›£æ§ç·¨è¼¯å™¨è®ŠåŒ– ==========');
    log('info', 'æ¯3ç§’æª¢æŸ¥ä¸€æ¬¡ï¼Œå†æ¬¡é»æ“ŠæŒ‰éˆ•åœæ­¢ç›£æ§');
    
    let previousCount = tinymce.editors.length;
    let checkCount = 0;
    
    monitorInterval = setInterval(() => {
        checkCount++;
        const currentCount = tinymce.editors.length;
        
        if (currentCount !== previousCount) {
            log('warning', `ç·¨è¼¯å™¨æ•¸é‡è®ŠåŒ–: ${previousCount} â†’ ${currentCount}`);
            identifyAllEditors();
            previousCount = currentCount;
        }
        
        // æª¢æŸ¥æ¨£å¼ç‹€æ…‹
        let injectedCount = 0;
        tinymce.editors.forEach(editor => {
            if (editor.dom && editor.getBody() && 
                editor.dom.hasClass(editor.getBody(), 'styles-injected')) {
                injectedCount++;
            }
        });
        
        if (injectedCount < currentCount) {
            log('warning', `æª¢æ¸¬åˆ° ${currentCount - injectedCount} å€‹ç·¨è¼¯å™¨ç¼ºå°‘æ¨£å¼`);
        }
        
        if (checkCount % 10 === 0) {
            log('info', `ç›£æ§ä¸­... (ç¬¬ ${checkCount} æ¬¡æª¢æŸ¥)`);
        }
    }, 3000);
}

// å…¨å±€å‡½æ•¸ä¾›å¤–éƒ¨èª¿ç”¨
window.TinyMCEDebugger = {
    identify: identifyAllEditors,
    checkStyles: checkEditorStyles,
    injectStyles: injectStylesToAll,
    test: testSpecificEditor,
    monitor: monitorEditorChanges,
    clear: clearLog
};

// è‡ªå‹•è¨­ç½®ç›£è½å™¨
if (typeof tinymce !== 'undefined') {
    tinymce.on('AddEditor', function(e) {
        log('warning', `æª¢æ¸¬åˆ°æ–°ç·¨è¼¯å™¨åŠ å…¥: ${e.editor.id}`);
        
        e.editor.on('init', function() {
            log('success', `ç·¨è¼¯å™¨ ${e.editor.id} å·²åˆå§‹åŒ–`);
            
            // å»¶é²æ³¨å…¥æ¨£å¼
            setTimeout(() => {
                if (window.autoInjectStyles) {
                    log('info', 'è‡ªå‹•æ³¨å…¥æ¨£å¼åˆ°æ–°ç·¨è¼¯å™¨...');
                    injectStylesToAll();
                }
            }, 500);
        });
    });
}
</script>

</body>
</html>